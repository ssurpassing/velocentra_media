# 会员规则说明

## 会员类型

### 1. 免费会员 (Free)
- **积分**: 0
- **生成次数**: 有限的免费次数
- **限制**: 只能使用免费次数

### 2. 积分会员 (Credits)
- **获取方式**: 购买积分包
- **积分**: 永不过期
- **生成次数**: 有限制（购买时获得）
- **限制**: 
  - 需要同时满足：有积分 + 有生成次数
  - 每次生成扣除积分和生成次数

#### 积分包套餐
| 套餐 | 价格 | 积分 | 生成次数 |
|------|------|------|----------|
| 入门包 | $9.99 | 1,000 | 300 |
| 专业包 | $49.99 | 5,000 | 1,000 |
| 高级包 | $99.99 | 10,000 | 3,000 |

### 3. 订阅会员 (Subscription)
- **获取方式**: 月付或年付订阅
- **积分**: 按订阅周期发放
- **生成次数**: **无限制** ✨
- **限制**: 
  - 只需满足：订阅有效 + 有积分
  - 每次生成只扣除积分，不扣除生成次数

#### 月付订阅（连续包月）
| 套餐 | 价格 | 每月积分 |
|------|------|----------|
| 基础月付 | $9.99/月 | 1,000 |
| 专业月付 | $49.99/月 | 5,000 |
| 高级月付 | $99.99/月 | 10,000 |

#### 年付订阅（一次性发放）
| 套餐 | 价格 | 一次性积分 | 节省 |
|------|------|-----------|------|
| 基础年付 | $95.88/年 | 12,000 | $24 |
| 专业年付 | $479.88/年 | 60,000 | $120 |
| 高级年付 | $959.88/年 | 120,000 | $240 |

## 充值规则

### 积分累加
- 所有充值的积分都会**累加**到现有积分
- 例如：有 1000 积分，充值 5000，总共 6000 积分

### 生成次数累加（仅积分包）
- 购买积分包时，生成次数也会**累加**
- 例如：剩余 50 次，购买 300 次套餐，总共 350 次

### 订阅时间累加
- 订阅时间会**累加**到现有订阅结束时间
- 如果订阅已过期，从当前时间开始计算
- 例如：
  - 订阅到 2025-12-31，再充值 1 个月 → 延长到 2026-01-31
  - 订阅到 2025-12-31，再充值 1 年 → 延长到 2026-12-31

### 混合充值示例
1. **先月付，后年付**:
   - 月付：5000 积分，订阅到 2025-12-31
   - 年付：+60000 积分，订阅延长到 2026-12-31
   - 结果：65000 积分，订阅到 2026-12-31

2. **先积分包，后订阅**:
   - 积分包：5000 积分 + 1000 次生成
   - 订阅：+5000 积分，订阅到 2025-12-31
   - 结果：10000 积分，订阅到 2025-12-31，**无限次生成**（订阅会员特权）

## 过期规则

### 积分过期
- **积分包积分**: 永不过期
- **订阅积分**: 永不过期（即使订阅过期）

### 订阅过期
- 订阅过期后，剩余积分**保留**
- 下次续订后，可以继续使用之前剩余的积分
- 例如：
  - 订阅到期时剩余 1000 积分
  - 续订后，这 1000 积分仍然可用

### 生成次数过期
- 积分包的生成次数**永不过期**
- 用完为止

## 生成限制检查

### 免费会员
```
检查：免费次数 > 0
```

### 积分会员
```
检查：积分 >= 所需积分 AND 生成次数 > 0
```

### 订阅会员
```
检查：订阅有效 AND 积分 >= 所需积分
```

## 扣除规则

### 免费会员
- 扣除：免费次数 -1

### 积分会员
- 扣除：积分 - N，生成次数 -1

### 订阅会员
- 扣除：积分 - N（不扣除生成次数）

## 会员权益对比

| 权益 | 免费会员 | 积分会员 | 订阅会员 |
|------|---------|---------|---------|
| 积分 | 0 | 购买获得 | 按周期发放 |
| 生成次数 | 有限 | 购买时获得 | **无限** ✨ |
| 积分过期 | - | 永不过期 | 永不过期 |
| 订阅过期后 | - | 积分保留 | 积分保留 |
| 优先处理 | ❌ | ✅ | ✅ |
| 专属客服 | ❌ | 高级包 | 高级套餐 |

## 实施说明

### 数据库字段
- `membership_tier`: 'free' | 'credits' | 'subscription'
- `credits`: 积分余额
- `free_generations_remaining`: 生成次数（免费会员和积分会员使用）
- `subscription_end_date`: 订阅结束时间

### Webhook 处理
- **积分包**: 累加积分 + 累加生成次数，设置 `membership_tier = 'credits'`
- **月付订阅**: 累加积分 + 延长 1 个月，设置 `membership_tier = 'subscription'`
- **年付订阅**: 累加 12 个月积分 + 延长 12 个月，设置 `membership_tier = 'subscription'`

### 生成检查逻辑
```typescript
if (membership_tier === 'subscription') {
  // 订阅会员：检查订阅有效期 + 积分
  if (subscription_end_date > now && credits >= required) {
    return true; // 无需检查生成次数
  }
} else if (membership_tier === 'credits') {
  // 积分会员：检查积分 + 生成次数
  if (credits >= required && free_generations_remaining > 0) {
    return true;
  }
}
```
